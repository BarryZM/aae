!function(){var l,U=[],s=!1;function d(e,t){for(var a,i,o=$G(e).children,r=0;i=o[r++];)if("focus"==i.className){a=i.getAttribute(t);break}return a}function r(e){return e?e=utils.trim(e).replace(/v\.youku\.com\/v_show\/id_([\w\-=]+)\.html/i,"player.youku.com/player.php/sid/$1/v.swf").replace(/(www\.)?youtube\.com\/watch\?v=([\w\-]+)/i,"www.youtube.com/v/$2").replace(/youtu.be\/(\w+)$/i,"www.youtube.com/v/$1").replace(/v\.ku6\.com\/.+\/([\w\.]+)\.html.*$/i,"player.ku6.com/refer/$1/v.swf").replace(/www\.56\.com\/u\d+\/v_([\w\-]+)\.html/i,"player.56.com/v_$1.swf").replace(/www.56.com\/w\d+\/play_album\-aid\-\d+_vid\-([^.]+)\.html/i,"player.56.com/v_$1.swf").replace(/v\.pps\.tv\/play_([\w]+)\.html.*$/i,"player.pps.tv/player/sid/$1/v.swf").replace(/www\.letv\.com\/ptv\/vplay\/([\d]+)\.html.*$/i,"i7.imgs.letv.com/player/swfPlayer.swf?id=$1&autoplay=0").replace(/www\.tudou\.com\/programs\/view\/([\w\-]+)\/?/i,"www.tudou.com/v/$1").replace(/v\.qq\.com\/cover\/[\w]+\/[\w]+\/([\w]+)\.html/i,"static.video.qq.com/TPout.swf?vid=$1").replace(/v\.qq\.com\/.+[\?\&]vid=([^&]+).*$/i,"static.video.qq.com/TPout.swf?vid=$1").replace(/my\.tv\.sohu\.com\/[\w]+\/[\d]+\/([\d]+)\.shtml.*$/i,"share.vrs.sohu.com/my/v.swf&id=$1"):""}function n(e){for(var t,a=$G(e).children,i=0;t=a[i++];)domUtils.on(t,"click",function(){for(var e,t=0;e=a[t++];)e.className="",e.removeAttribute&&e.removeAttribute("class");this.className="focus"})}function u(e){if(e){var t=r(e);$G("preview").innerHTML='<div class="previewMsg"><span>'+lang.urlError+'</span></div><embed class="previewVideo" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" src="'+t+'" width="420" height="280" wmode="transparent" play="true" loop="false" menu="false" allowscriptaccess="never" allowfullscreen="true" ></embed>'}}function t(e){this.$wrap=e.constructor==String?$("#"+e):$(e),this.init()}window.onload=function(){var e;$focus($G("videoUrl")),function(){for(var o=$G("tabHeads").children,e=0;e<o.length;e++)domUtils.on(o[e],"click",function(e){var t,a,i=e.target||e.srcElement;for(t=0;t<o.length;t++)a=o[t].getAttribute("data-content-id"),o[t]==i?(domUtils.addClass(o[t],"focus"),domUtils.addClass($G(a),"focus")):(domUtils.removeClasses(o[t],"focus"),domUtils.removeClasses($G(a),"focus"))})}(),function(e){for(var t,a=0;t=e[a++];){var i=$G(t),o={none:lang.default,left:lang.floatLeft,right:lang.floatRight,center:lang.block};for(var r in o){var s=document.createElement("div");s.setAttribute("name",r),"none"==r&&(s.className="focus"),s.style.cssText="background:url(images/"+r+"_focus.jpg);",s.setAttribute("title",o[r]),i.appendChild(s)}n(t)}}(["videoFloat","upload_alignment"]),e=$G("videoUrl"),browser.ie?e.onpropertychange=function(){u(this.value)}:e.addEventListener("input",function(){u(this.value)},!1),dialog.onok=function(){$G("preview").innerHTML="";var e,t,a,i,o=d("tabHeads","tabSrc");switch(o){case"video":return e=$G("videoWidth"),t=$G("videoHeight"),a=$G("videoUrl").value,i=d("videoFloat","name"),!!a&&!!function(e){for(var t,a=0;t=e[a++];){var i=t.value;if(!/(0|^[1-9]\d*$)/.test(i)&&i)return alert(lang.numError),t.value="",t.focus(),!1}return!0}([e,t])&&void editor.execCommand("insertvideo",{url:r(a),width:e.value,height:t.value,align:i},s?"upload":null);case"videoSearch":return function(e){for(var t,a=domUtils.getElementsByTagName($G(e),"img"),i=[],o=0;t=a[o++];)t.getAttribute("selected")&&i.push({url:t.getAttribute("ue_video_url"),width:420,height:280,align:"none"});editor.execCommand("insertvideo",i)}("searchList");case"upload":return function(){var e=[],t=editor.getOpt("videoUrlPrefix"),a=$G("upload_width").value||420,i=$G("upload_height").value||280,o=d("upload_alignment","name")||"none";for(var r in U){var s=U[r];e.push({url:t+s.url,width:a,height:i,align:o})}var n=l.getQueueCount();if(n)return $(".info","#queueList").html('<span style="color:red;">'+"还有2个未上传文件".replace(/[\d]/,n)+"</span>"),!1;editor.execCommand("insertvideo",e,"upload")}()}},dialog.oncancel=function(){$G("preview").innerHTML=""},function(){var e,t=editor.selection.getRange().getClosedNode();if(t&&t.className){var a="edui-faked-video"==t.className,i=-1!=t.className.indexOf("edui-upload-video");if(a||i){$G("videoUrl").value=e=t.getAttribute("_url"),$G("videoWidth").value=t.width,$G("videoHeight").value=t.height;var o=domUtils.getComputedStyle(t,"float"),r=domUtils.getComputedStyle(t.parentNode,"text-align");!function(e){for(var t,a=$G("videoFloat").children,i=0;t=a[i++];)t.getAttribute("name")==e?"focus"!=t.className&&(t.className="focus"):"focus"==t.className&&(t.className="")}("center"===r?"center":o)}i&&(s=!0)}u(e)}(),l=new t("queueList")},t.prototype={init:function(){this.fileList=[],this.initContainer(),this.initUploader()},initContainer:function(){this.$queue=this.$wrap.find(".filelist")},initUploader:function(){var d,e,t,i=this,u=jQuery,a=i.$wrap,o=a.find(".filelist"),r=a.find(".statusBar"),s=r.find(".info"),n=a.find(".uploadBtn"),c=(a.find(".filePickerBtn"),a.find(".filePickerBlock")),l=a.find(".placeholder"),p=r.find(".progress").hide(),f=0,m=0,v=window.devicePixelRatio||1,g=113*v,h=113*v,w="",b={},y=(e=document.createElement("p").style,t="transition"in e||"WebkitTransition"in e||"MozTransition"in e||"msTransition"in e||"OTransition"in e,e=null,t),$=editor.getActionUrl(editor.getOpt("videoActionName")),C=editor.getOpt("videoMaxSize"),x=(editor.getOpt("videoAllowFiles")||[]).join("").replace(/\./g,",").replace(/^[,]/,"");function k(a){var i=u('<li id="'+a.id+'"><p class="title">'+a.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),o=u('<div class="file-panel"><span class="cancel">'+lang.uploadDelete+'</span><span class="rotateRight">'+lang.uploadTurnRight+'</span><span class="rotateLeft">'+lang.uploadTurnLeft+"</span></div>").appendTo(i),r=i.find("p.progress span"),s=i.find("p.imgWrap"),n=u('<p class="error"></p>').hide().appendTo(i),l=function(e){switch(e){case"exceed_size":text=lang.errorExceedSize;break;case"interrupt":text=lang.errorInterrupt;break;case"http":text=lang.errorHttp;break;case"not_allow_type":text=lang.errorFileType;break;default:text=lang.errorUploadRetry}n.text(text).show()};"invalid"===a.getStatus()?l(a.statusText):(s.text(lang.uploadPreview),-1=="|png|jpg|jpeg|bmp|gif|".indexOf("|"+a.ext.toLowerCase()+"|")?s.empty().addClass("notimage").append('<i class="file-preview file-type-'+a.ext.toLowerCase()+'"></i><span class="file-title">'+a.name+"</span>"):browser.ie&&browser.version<=7?s.text(lang.uploadNoPreview):d.makeThumb(a,function(e,t){if(e||!t||/^data:/.test(t)&&browser.ie&&browser.version<=7)s.text(lang.uploadNoPreview);else{var a=u('<img src="'+t+'">');s.empty().append(a),a.on("error",function(){s.text(lang.uploadNoPreview)})}},g,h),b[a.id]=[a.size,0],a.rotation=0,a.ext&&-1!=x.indexOf(a.ext.toLowerCase())||(l("not_allow_type"),d.removeFile(a))),a.on("statuschange",function(e,t){"progress"===t?r.hide().width(0):"queued"===t&&(i.off("mouseenter mouseleave"),o.remove()),"error"===e||"invalid"===e?(l(a.statusText),b[a.id][1]=1):"interrupt"===e?l("interrupt"):"queued"===e?b[a.id][1]=0:"progress"===e&&(n.hide(),r.css("display","block")),i.removeClass("state-"+t).addClass("state-"+e)}),i.on("mouseenter",function(){o.stop().animate({height:30})}),i.on("mouseleave",function(){o.stop().animate({height:0})}),o.on("click","span",function(){var e;switch(u(this).index()){case 0:return void d.removeFile(a);case 1:a.rotation+=90;break;case 2:a.rotation-=90}y?(e="rotate("+a.rotation+"deg)",s.css({"-webkit-transform":e,"-mos-transform":e,"-o-transform":e,transform:e})):s.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(a.rotation/90%4+4)%4+")")}),i.insertBefore(c)}function _(){var e,a=0,i=0,t=p.children();u.each(b,function(e,t){i+=t[0],a+=t[0]*t[1]}),e=i?a/i:0,t.eq(0).text(Math.round(100*e)+"%"),t.eq(1).css("width",Math.round(100*e)+"%"),N()}function S(e,t){if(e!=w){var a=d.getStats();switch(n.removeClass("state-"+w),n.addClass("state-"+e),e){case"pedding":o.addClass("element-invisible"),r.addClass("element-invisible"),l.removeClass("element-invisible"),p.hide(),s.hide(),d.refresh();break;case"ready":l.addClass("element-invisible"),o.removeClass("element-invisible"),r.removeClass("element-invisible"),p.hide(),s.show(),n.text(lang.uploadStart),d.refresh();break;case"uploading":p.show(),s.hide(),n.text(lang.uploadPause);break;case"paused":p.show(),s.hide(),n.text(lang.uploadContinue);break;case"confirm":if(p.show(),s.hide(),n.text(lang.uploadStart),(a=d.getStats()).successNum&&!a.uploadFailNum)return void S("finish");break;case"finish":p.hide(),s.show(),a.uploadFailNum?n.text(lang.uploadRetry):n.text(lang.uploadStart)}w=e,N()}i.getQueueCount()?n.removeClass("disabled"):n.addClass("disabled")}function N(){var e,t="";"ready"===w?t=lang.updateStatusReady.replace("_",f).replace("_KB",WebUploader.formatSize(m)):"confirm"===w?(e=d.getStats()).uploadFailNum&&(t=lang.updateStatusConfirm.replace("_",e.successNum).replace("_",e.successNum)):(e=d.getStats(),t=lang.updateStatusFinish.replace("_",f).replace("_KB",WebUploader.formatSize(m)).replace("_",e.successNum),e.uploadFailNum&&(t+=lang.updateStatusError.replace("_",e.uploadFailNum))),s.html(t)}WebUploader.Uploader.support()?editor.getOpt("videoActionName")?((d=i.uploader=WebUploader.create({pick:{id:"#filePickerReady",label:lang.uploadSelectFile},swf:"../../third-party/webuploader/Uploader.swf",server:$,fileVal:editor.getOpt("videoFieldName"),duplicate:!0,fileSingleSizeLimit:C,compress:!1})).addButton({id:"#filePickerBlock"}),d.addButton({id:"#filePickerBtn",label:lang.uploadAddFile}),S("pedding"),d.on("fileQueued",function(e){f++,m+=e.size,1===f&&(l.addClass("element-invisible"),r.show()),k(e)}),d.on("fileDequeued",function(e){var t,a;f--,m-=e.size,a=u("#"+(t=e).id),delete b[t.id],_(),a.off().find(".file-panel").off().end().remove(),_()}),d.on("filesQueued",function(e){d.isInProgress()||"pedding"!=w&&"finish"!=w&&"confirm"!=w&&"ready"!=w||S("ready"),_()}),d.on("all",function(e,t){switch(e){case"uploadFinished":S("confirm");break;case"startUpload":var a=utils.serializeParam(editor.queryCommandValue("serverparam"))||"",i=utils.formatUrl($+(-1==$.indexOf("?")?"?":"&")+"encode=utf-8&"+a);d.option("server",i),S("uploading");break;case"stopUpload":S("paused")}}),d.on("uploadBeforeSend",function(e,t,a){-1!=$.toLowerCase().indexOf("jsp")&&(a.X_Requested_With="XMLHttpRequest")}),d.on("uploadProgress",function(e,t){u("#"+e.id).find(".progress span").css("width",100*t+"%"),b[e.id][1]=t,_()}),d.on("uploadSuccess",function(e,t){var a=u("#"+e.id);try{var i=t._raw||t,o=utils.str2json(i);"SUCCESS"==o.state?(U.push({url:o.url,type:o.type,original:o.original}),a.append('<span class="success"></span>')):a.find(".error").text(o.state).show()}catch(e){a.find(".error").text(lang.errorServerUpload).show()}}),d.on("uploadError",function(e,t){}),d.on("error",function(e,t){"Q_TYPE_DENIED"!=e&&"F_EXCEED_SIZE"!=e||k(t)}),d.on("uploadComplete",function(e,t){}),n.on("click",function(){if(u(this).hasClass("disabled"))return!1;"ready"===w?d.upload():"paused"===w?d.upload():"uploading"===w&&d.stop()}),n.addClass("state-"+w),_()):u("#filePickerReady").after(u("<div>").html(lang.errorLoadConfig)).hide():u("#filePickerReady").after(u("<div>").html(lang.errorNotSupport)).hide()},getQueueCount:function(){var e,t,a,i=0,o=this.uploader.getFiles();for(t=0;e=o[t++];)"queued"!=(a=e.getStatus())&&"uploading"!=a&&"progress"!=a||i++;return i},refresh:function(){this.uploader.refresh()}}}();